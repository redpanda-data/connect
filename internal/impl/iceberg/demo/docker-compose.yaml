# Docker Compose for local Iceberg connector testing
#
# Usage:
#   docker compose up -d
#
# Then run redpanda-connect with the example config:
#   go run ./cmd/redpanda-connect run ./internal/impl/iceberg/integration/example-config.yaml
#
# See example-config.yaml for DuckDB query instructions.

services:
  minio:
    image: minio/minio:latest
    network_mode: host
    environment:
      MINIO_ROOT_USER: admin
      MINIO_ROOT_PASSWORD: password
      MINIO_REGION: us-east-1
    command: server /data --address ":9000" --console-address ":9001"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Creates the warehouse bucket on startup
  minio-setup:
    image: minio/mc:latest
    network_mode: host
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://localhost:9000 admin password;
      mc mb --ignore-existing myminio/warehouse;
      mc anonymous set public myminio/warehouse;
      exit 0;
      "

  rest:
    image: apache/iceberg-rest-fixture
    network_mode: host
    environment:
      # REST catalog configuration
      CATALOG_WAREHOUSE: s3://warehouse/
      CATALOG_IO__IMPL: org.apache.iceberg.aws.s3.S3FileIO
      CATALOG_S3_ENDPOINT: http://localhost:9000
      CATALOG_S3_PATH__STYLE__ACCESS: "true"
      CATALOG_S3_ACCESS__KEY__ID: admin
      CATALOG_S3_SECRET__ACCESS__KEY: password
      AWS_REGION: us-east-1
    depends_on:
      minio-setup:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8181/v1/config"]
      interval: 5s
      timeout: 5s
      retries: 5
