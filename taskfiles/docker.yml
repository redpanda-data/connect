version: '3'

tasks:
  init:
    desc: Initialize Docker buildx with docker-container driver
    cmds:
      - |
        if docker buildx inspect container >/dev/null 2>&1; then
          docker buildx use container
        else
          docker buildx create --use --name container --driver docker-container --driver-opt network=host --bootstrap
        fi
    silent: true

  redpanda-connect:
    desc: Build main Docker image using goreleaser for local development
    aliases:
      - main
    cmd:
      task: build
      vars:
        CONFIG_FILE: .goreleaser/connect.yaml

  redpanda-connect-cloud:
    desc: Build cloud Docker image using goreleaser for local development
    aliases:
      - cloud
    cmd:
      task: build
      vars:
        CONFIG_FILE: .goreleaser/connect-cloud.yaml

  redpanda-connect-ai:
    desc: Build AI Docker image using goreleaser for local development
    aliases:
      - ai
    cmd:
      task: build
      vars:
        CONFIG_FILE: .goreleaser/connect-ai.yaml

  build:
    internal: true
    vars:
      CONFIG_FILE: '{{.CONFIG_FILE}}'
      GOARCH: '{{.GOARCH | default "arm64"}}'
    cmd: >
      goreleaser release --snapshot --clean --skip=archive,nfpm,publish
      --config=<(yq 
      '.builds[0].goos = ["linux"] |
      .builds[0].goarch = ["{{.GOARCH}}"] |
      .dockers_v2[0].platforms = ["linux/{{.GOARCH}}"] |
      .checksum.disable = true'
      {{.CONFIG_FILE}})

  pull-redpanda:
    desc: Pull latest version of Redpanda for local development/testing
    vars:
      IMAGE_BASE: 'docker.redpanda.com/redpandadata/redpanda'
      IMAGE_TAG: '{{.IMAGE_TAG | default "latest"}}'
    cmds:
      - echo "Pulling latest Redpanda version..."
      - docker pull {{.IMAGE_BASE }}:{{ .IMAGE_TAG }}
      - docker inspect {{.IMAGE_BASE }}:{{ .IMAGE_TAG }} | jq '[.[].RepoTags[]]'
