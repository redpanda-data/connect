version: '3'

tasks:
  unit:
    desc: Run unit tests
    aliases:
      - ut
    vars:
      TIMEOUT: '{{if .CI}}5m{{else}}1m{{end}}'
    preconditions:
      - sh: command -v {{.TOOLS_BIN_DIR}}/gotestfmt
        msg: "gotestfmt is not installed. Run 'task tools:install-gotestfmt' first."
    cmds:
      - go test {{.GO_FLAGS}} -json -timeout {{.TIMEOUT}} -shuffle=on {{if .CI}}{{else}}-v{{end}} ./... 2>&1 | tee /tmp/gotest.log | {{.TOOLS_BIN_DIR}}/gotestfmt

  unit-race:
    desc: Run unit tests with race detection
    aliases:
      - ut-race
    preconditions:
      - sh: command -v {{.TOOLS_BIN_DIR}}/gotestfmt
        msg: "gotestfmt is not installed. Run 'task tools:install-gotestfmt' first."
    cmds:
      - go test {{.GO_FLAGS}} -json -timeout 3m -shuffle=on -race {{if .CI}}{{else}}-v{{end}} ./... 2>&1 | tee /tmp/gotest.log | {{.TOOLS_BIN_DIR}}/gotestfmt

  integration-package:
    desc: Run integration tests for package PKG
    aliases:
      - it
    requires:
      vars:
        - PKG
    vars:
      TIMEOUT: '{{if .CI}}15m{{else}}5m{{end}}'
    preconditions:
      - sh: command -v {{.TOOLS_BIN_DIR}}/gotestfmt
        msg: "gotestfmt is not installed. Run 'task tools:install-gotestfmt' first."
    cmds:
      - go test {{.GO_FLAGS}} -json -run "^Test.*Integration" -timeout {{.TIMEOUT}} {{if .CI}}{{else}}-v{{end}} {{.PKG}} 2>&1 | tee /tmp/gotest.log | {{.TOOLS_BIN_DIR}}/gotestfmt

  template:
    desc: Run template tests
    aliases:
      - tmpl
    deps:
      - :build:redpanda-connect
    vars:
      TEMPLATE_FILES:
        sh: find internal/impl -type f -name "*tmpl.yaml" | tr '\n' ' '
    preconditions:
      - sh: command -v {{.TOOLS_BIN_DIR}}/gotestfmt
        msg: "gotestfmt is not installed. Run 'task tools:install-gotestfmt' first."
    cmds:
      - '{{.TARGET_DIR}}/redpanda-connect template lint {{.TEMPLATE_FILES}}'
      - '{{.TARGET_DIR}}/redpanda-connect test ./config/test/...'
      - '{{.TARGET_DIR}}/redpanda-connect template lint ./config/rag/templates/...'

